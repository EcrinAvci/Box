<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konteyner Kutu Yerleştirme Görselleştirmesi</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        #container {
            width: 100vw;
            height: 100vh;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 100;
        }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 100;
        }
        .control-group {
            margin-bottom: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin: 2px;
        }
        button:hover {
            background: #45a049;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 200;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="loading">Yükleniyor...</div>
    <div id="info">
        <h3>Konteyner Bilgileri</h3>
        <div id="container-info">Yükleniyor...</div>
    </div>
    <div id="controls">
        <h3>Kontroller</h3>
        <div class="control-group">
            <button onclick="resetCamera()">Kamerayı Sıfırla</button>
            <button onclick="toggleWireframe()">Tel Kafes Modu</button>
        </div>
        <div class="control-group">
            <button onclick="toggleAnimation()">Animasyon</button>
            <button onclick="showBoxInfo()">Kutu Bilgileri</button>
        </div>
        <div class="control-group">
            <h4>Yeni Kutu Ekle</h4>
            <input type="number" id="newBoxX" placeholder="Genişlik" min="1" max="100" style="width: 60px; margin: 2px;">
            <input type="number" id="newBoxY" placeholder="Yükseklik" min="1" max="100" style="width: 60px; margin: 2px;">
            <input type="number" id="newBoxZ" placeholder="Derinlik" min="1" max="100" style="width: 60px; margin: 2px;">
            <input type="number" id="newBoxWeight" placeholder="Ağırlık" min="0.1" step="0.1" style="width: 60px; margin: 2px;">
            <button onclick="addNewBox()" style="margin-top: 5px;">Kutu Ekle</button>
            <div style="margin-top: 5px;">
                <label style="font-size: 12px;">Animasyon Hızı:</label>
                <input type="range" id="animationSpeed" min="0.01" max="0.05" step="0.01" value="0.02" style="width: 80px;">
                <span id="speedValue" style="font-size: 10px;">0.02</span>
            </div>
            <button onclick="downloadJSON()" style="margin-top: 5px; background: #2196F3;">JSON İndir</button>
        </div>
        <div class="control-group">
            <p>Mouse: Döndür</p>
            <p>Wheel: Zoom</p>
            <p>Right Click: Pan</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script>
        let scene, camera, renderer, controls;
        let container, boxes = [];
        let wireframeMode = false;
        let animationMode = false;
        let placementData = null;

        // Sahneyi başlat
        function init() {
            // Sahne oluştur
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);

            // Kamera oluştur
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(150, 150, 150);

            // Renderer oluştur
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('container').appendChild(renderer.domElement);

            // Kontroller
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // Işıklandırma
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(100, 100, 50);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);

            // Veriyi yükle
            loadPlacementData();
        }

        // JSON verisini yükle
        async function loadPlacementData() {
            try {
                const response = await fetch('placement_result.json');
                placementData = await response.json();
                createVisualization();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Veri yüklenemedi:', error);
                document.getElementById('loading').innerHTML = 'Veri yüklenemedi!<br>placement_result.json dosyasını kontrol edin.';
            }
        }

        // Görselleştirmeyi oluştur
        function createVisualization() {
            if (!placementData) return;

            // Konteyner oluştur
            createContainer();
            
            // Kutuları oluştur
            createBoxes();

            // Bilgi panelini güncelle
            updateInfo();

            // Animasyon başlat
            animate();
        }

        // Konteyner oluştur
        function createContainer() {
            const { width, height, depth } = placementData.container;
            
            // Konteyner geometrisi (wireframe)
            const containerGeometry = new THREE.BoxGeometry(width, height, depth);
            const containerMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x00ff00, 
                wireframe: true,
                transparent: true,
                opacity: 0.3
            });
            
            container = new THREE.Mesh(containerGeometry, containerMaterial);
            container.position.set(width/2, height/2, depth/2);
            scene.add(container);
        }

        // Kutuları oluştur
        function createBoxes() {
            placementData.boxes.forEach((boxData, index) => {
                const geometry = new THREE.BoxGeometry(boxData.X, boxData.Y, boxData.Z);
                const material = new THREE.MeshLambertMaterial({ 
                    color: getRandomColor(index),
                    transparent: true,
                    opacity: 0.8
                });
                
                const box = new THREE.Mesh(geometry, material);
                
                // Kutu pozisyonu (Three.js'de kutunun merkezi koordinat olur)
                box.position.set(
                    boxData.posX + boxData.X/2,
                    boxData.posY + boxData.Y/2,
                    boxData.posZ + boxData.Z/2
                );
                
                box.castShadow = true;
                box.receiveShadow = true;
                
                // Kutu bilgilerini sakla
                box.userData = boxData;
                
                boxes.push(box);
                scene.add(box);
            });
        }

        // Rastgele renk üret
        function getRandomColor(index) {
            const colors = [0xff6b6b, 0x4ecdc4, 0x45b7d1, 0x96ceb4, 0xfeca57, 0xff9ff3, 0x54a0ff, 0x5f27cd];
            return colors[index % colors.length];
        }

        // Bilgi panelini güncelle
        function updateInfo() {
            const info = document.getElementById('container-info');
            const totalBoxes = placementData.boxes.length;
            const totalVolume = placementData.boxes.reduce((sum, box) => sum + box.Volume, 0);
            const containerVolume = placementData.container.width * placementData.container.height * placementData.container.depth;
            const utilizationRate = (totalVolume / containerVolume) * 100;
            
            info.innerHTML = `
                <p><strong>Konteyner Boyutları:</strong> ${placementData.container.width} x ${placementData.container.height} x ${placementData.container.depth}</p>
                <p><strong>Yerleştirilen Kutu Sayısı:</strong> ${totalBoxes}</p>
                <p><strong>Doluluk Oranı:</strong> ${utilizationRate.toFixed(2)}%</p>
                <p><strong>Toplam Yerleştirilen Hacim:</strong> ${totalVolume.toFixed(0)}</p>
                <p><strong>Konteyner Hacmi:</strong> ${containerVolume.toFixed(0)}</p>
            `;
        }

        // Animasyon döngüsü
        function animate() {
            requestAnimationFrame(animate);
            
            if (animationMode) {
                boxes.forEach((box, index) => {
                    box.rotation.y += 0.01;
                });
            }
            
            controls.update();
            renderer.render(scene, camera);
        }

        // Pencere boyutu değiştiğinde
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Kontrol fonksiyonları
        function resetCamera() {
            camera.position.set(150, 150, 150);
            controls.reset();
        }

        function toggleWireframe() {
            wireframeMode = !wireframeMode;
            boxes.forEach(box => {
                box.material.wireframe = wireframeMode;
            });
            container.material.wireframe = !wireframeMode;
        }

        function toggleAnimation() {
            animationMode = !animationMode;
            if (!animationMode) {
                boxes.forEach(box => {
                    box.rotation.set(0, 0, 0);
                });
            }
        }

        function showBoxInfo() {
            console.log('Kutu Bilgileri:');
            placementData.boxes.forEach((box, index) => {
                console.log(`Kutu ${index + 1}: Konum(${box.posX}, ${box.posY}, ${box.posZ}) Boyutlar(${box.X}x${box.Y}x${box.Z}) Hacim: ${box.Volume}`);
            });
        }

        // Yeni kutu ekleme fonksiyonu
        function addNewBox() {
            const x = parseInt(document.getElementById('newBoxX').value);
            const y = parseInt(document.getElementById('newBoxY').value);
            const z = parseInt(document.getElementById('newBoxZ').value);
            const weight = parseFloat(document.getElementById('newBoxWeight').value);

            if (!x || !y || !z || !weight) {
                alert('Lütfen tüm alanları doldurun!');
                return;
            }

            if (x > 100 || y > 100 || z > 100) {
                alert('Kutu boyutları konteyner boyutlarından büyük olamaz!');
                return;
            }

            // Yeni kutu verisi
            const newBox = {
                X: x,
                Y: y,
                Z: z,
                Weight: weight,
                Volume: x * y * z
            };

            // Basit yerleştirme algoritması (boş yer bul)
            const position = findEmptyPosition(newBox);
            
            if (position) {
                // Yeni kutuyu listeye ekle
                const newPlacedBox = {
                    ...newBox,
                    posX: position.x,
                    posY: position.y,
                    posZ: position.z
                };
                
                placementData.boxes.push(newPlacedBox);
                
                // 3D görselleştirmeye ekle
                addBoxToScene(newPlacedBox, placementData.boxes.length - 1);
                
                // Bilgi panelini güncelle
                updateInfo();
                
                // Formu temizle
                document.getElementById('newBoxX').value = '';
                document.getElementById('newBoxY').value = '';
                document.getElementById('newBoxZ').value = '';
                document.getElementById('newBoxWeight').value = '';
                
                console.log(`Yeni kutu eklendi: ${x}x${y}x${z} pozisyon: (${position.x}, ${position.y}, ${position.z})`);
            } else {
                alert('Konteynerde yeterli boş alan yok!');
            }
        }

        // Boş pozisyon bulma
        function findEmptyPosition(boxData) {
            // Basit grid tabanlı arama
            for (let z = 0; z <= 100 - boxData.Z; z++) {
                for (let y = 0; y <= 100 - boxData.Y; y++) {
                    for (let x = 0; x <= 100 - boxData.X; x++) {
                        if (canPlaceBox(x, y, z, boxData.X, boxData.Y, boxData.Z)) {
                            return { x, y, z };
                        }
                    }
                }
            }
            return null;
        }

        // Kutu yerleştirilebilir mi kontrol et
        function canPlaceBox(x, y, z, width, height, depth) {
            for (let i = x; i < x + width; i++) {
                for (let j = y; j < y + height; j++) {
                    for (let k = z; k < z + depth; k++) {
                        // Mevcut kutularla çakışma kontrolü
                        for (const existingBox of placementData.boxes) {
                            if (i >= existingBox.posX && i < existingBox.posX + existingBox.X &&
                                j >= existingBox.posY && j < existingBox.posY + existingBox.Y &&
                                k >= existingBox.posZ && k < existingBox.posZ + existingBox.Z) {
                                return false;
                            }
                        }
                    }
                }
            }
            return true;
        }

        // Sahneye yeni kutu ekle
        function addBoxToScene(boxData, index) {
            const geometry = new THREE.BoxGeometry(boxData.X, boxData.Y, boxData.Z);
            const material = new THREE.MeshLambertMaterial({ 
                color: getRandomColor(index),
                transparent: true,
                opacity: 0.8
            });
            
            const box = new THREE.Mesh(geometry, material);
            
            // Başlangıç pozisyonu (yukarıda)
            const startY = 200;
            box.position.set(
                boxData.posX + boxData.X/2,
                startY,
                boxData.posZ + boxData.Z/2
            );
            
            // Hedef pozisyonu
            const targetY = boxData.posY + boxData.Y/2;
            
            box.castShadow = true;
            box.receiveShadow = true;
            box.userData = boxData;
            box.userData.animationData = {
                startY: startY,
                targetY: targetY,
                progress: 0,
                isAnimating: true
            };
            
            boxes.push(box);
            scene.add(box);
            
            // Animasyon başlat
            animateBoxDrop(box);
        }

        // Kutu düşme animasyonu
        function animateBoxDrop(box) {
            const animationData = box.userData.animationData;
            const speed = parseFloat(document.getElementById('animationSpeed').value);
            
            function animate() {
                if (animationData.isAnimating) {
                    animationData.progress += speed; // Dinamik hız
                    
                    if (animationData.progress >= 1) {
                        // Animasyon tamamlandı
                        box.position.y = animationData.targetY;
                        animationData.isAnimating = false;
                        
                        // Yerleşme efekti
                        createPlacementEffect(box.position.x, box.position.y, box.position.z);
                    } else {
                        // Easing fonksiyonu (yavaşlayarak düşme)
                        const easeOut = 1 - Math.pow(1 - animationData.progress, 3);
                        box.position.y = animationData.startY + (animationData.targetY - animationData.startY) * easeOut;
                        
                        requestAnimationFrame(animate);
                    }
                }
            }
            
            animate();
        }

        // Yerleşme efekti (parçacık efekti)
        function createPlacementEffect(x, y, z) {
            // Basit parçacık efekti
            for (let i = 0; i < 10; i++) {
                const particleGeometry = new THREE.SphereGeometry(0.5, 8, 8);
                const particleMaterial = new THREE.MeshBasicMaterial({ 
                    color: 0xffff00,
                    transparent: true,
                    opacity: 0.8
                });
                
                const particle = new THREE.Mesh(particleGeometry, particleMaterial);
                particle.position.set(x, y, z);
                
                // Rastgele yön
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * 5 + 2;
                particle.userData.velocity = {
                    x: Math.cos(angle) * radius,
                    y: Math.random() * 3 + 1,
                    z: Math.sin(angle) * radius
                };
                particle.userData.life = 1.0;
                
                scene.add(particle);
                
                // Parçacık animasyonu
                animateParticle(particle);
            }
        }

        // Parçacık animasyonu
        function animateParticle(particle) {
            function animate() {
                if (particle.userData.life > 0) {
                    particle.position.x += particle.userData.velocity.x * 0.1;
                    particle.position.y += particle.userData.velocity.y * 0.1;
                    particle.position.z += particle.userData.velocity.z * 0.1;
                    
                    particle.userData.velocity.y -= 0.05; // Yerçekimi
                    particle.userData.life -= 0.02;
                    particle.material.opacity = particle.userData.life;
                    
                    requestAnimationFrame(animate);
                } else {
                    scene.remove(particle);
                }
            }
            
            animate();
        }

        // JSON dosyasını indirme fonksiyonu
        function downloadJSON() {
            // Güncel veriyi hazırla
            const currentData = {
                container: placementData.container,
                boxes: placementData.boxes,
                metadata: {
                    totalBoxes: placementData.boxes.length,
                    totalVolume: placementData.boxes.reduce((sum, box) => sum + box.Volume, 0),
                    containerVolume: placementData.container.width * placementData.container.height * placementData.container.depth,
                    utilizationRate: (placementData.boxes.reduce((sum, box) => sum + box.Volume, 0) / (placementData.container.width * placementData.container.height * placementData.container.depth)) * 100,
                    exportDate: new Date().toISOString(),
                    exportSource: "Web Interface"
                }
            };
            
            const data = JSON.stringify(currentData, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `placement_result_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('JSON dosyası indirildi:', a.download);
        }

        // Başlat
        init();

        // Animasyon hızı kontrolü
        document.getElementById('animationSpeed').addEventListener('input', function() {
            document.getElementById('speedValue').textContent = this.value;
        });
    </script>
</body>
</html> 